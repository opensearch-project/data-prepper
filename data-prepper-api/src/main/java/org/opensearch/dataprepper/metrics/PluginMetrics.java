/*
 * Copyright OpenSearch Contributors
 * SPDX-License-Identifier: Apache-2.0
 */

package org.opensearch.dataprepper.metrics;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.DistributionSummary;
import io.micrometer.core.instrument.Metrics;
import io.micrometer.core.instrument.Tag;
import io.micrometer.core.instrument.Timer;
import org.opensearch.dataprepper.model.configuration.PluginSetting;

import java.util.StringJoiner;
import java.util.function.ToDoubleFunction;

/**
 * Provides reference to APIs that register timer, counter, gauge into global registry.
 * See https://micrometer.io/docs/concepts#_registry
 */
public class PluginMetrics {

    private final String metricsPrefix;

    public static PluginMetrics fromPluginSetting(final PluginSetting pluginSetting, final String name) {
        if(pluginSetting.getPipelineName() == null) {
            throw new IllegalArgumentException("PluginSetting.pipelineName must not be null");
        }
        return PluginMetrics.fromNames(name, pluginSetting.getPipelineName());
    }

    public static PluginMetrics fromPluginSetting(final PluginSetting pluginSetting) {
        return fromPluginSetting(pluginSetting, pluginSetting.getName());
    }

    /**
     * Provides reference to APIs that register timer, counter, gauge into global registry.
     *
     * @param componentId It can be either pluginId or Data Prepper core component id
     * @param componentScope It can be pipeline name or Data Prepper core component
     * @return The {@link PluginMetrics}
     */
    public static PluginMetrics fromNames(final String componentId, final String componentScope) {
        return new PluginMetrics(new StringJoiner(MetricNames.DELIMITER)
                .add(componentScope)
                .add(componentId).toString());
    }

    /**
     * Provides reference to APIs that register timer, counter, gauge into global registry.
     *
     * @param metricsPrefix the prefix to provide to metrics
     * @return The {@link PluginMetrics}
     */
    public static PluginMetrics fromPrefix(final String metricsPrefix) {
        return new PluginMetrics(metricsPrefix);
    }

    private  PluginMetrics(final String metricsPrefix) {
        this.metricsPrefix = metricsPrefix;
    }

    public Counter counter(final String name) {
        return Metrics.counter(getMeterName(name));
    }

    public Counter counterWithTags(final String name, final String... tags) {
        return Metrics.counter(getMeterName(name), tags);
    }

    public Counter counter(final String name, final String metricsPrefix) {
        return Metrics.counter(new StringJoiner(MetricNames.DELIMITER).add(metricsPrefix).add(name).toString());
    }

    public Timer timer(final String name) {
        return Metrics.timer(getMeterName(name));
    }

    public Timer timerWithTags(final String name, final String... tags) {
        return Metrics.timer(getMeterName(name), tags);
    }

    public DistributionSummary summary(final String name) {
        return Metrics.summary(getMeterName(name));
    }

    public <T extends Number> T gauge(final String name, T number) {
        return Metrics.gauge(getMeterName(name), number);
    }

    public <T> T gauge(String name, T obj, ToDoubleFunction<T> valueFunction) {
        return Metrics.gauge(getMeterName(name), obj, valueFunction);
    }

    public <T> T gaugeWithTags(String name, Iterable<Tag> tags, T obj, ToDoubleFunction<T> valueFunction) {
        return Metrics.gauge(getMeterName(name), tags, obj, valueFunction);
    }

    private String getMeterName(final String name) {
        return new StringJoiner(MetricNames.DELIMITER).add(metricsPrefix).add(name).toString();
    }
}
