plugins {
    id 'com.google.cloud.tools.jib' version '3.4.0'
}

dependencies {
    implementation project(':data-prepper-main')
}

jib {
    from {
        image = 'amazoncorretto:21-al2023'
        platforms {
            platform {
                architecture = 'amd64'
                os = 'linux'
            }
            platform {
                architecture = 'arm64'
                os = 'linux'
            }
        }

    }
    to {
        image = "${project.rootProject.name}:${project.version}"
    }
    container {
        mainClass = 'org.opensearch.dataprepper.DataPrepperExecute'
        environment = [
          'ENV_CONFIG_FILEPATH': '/usr/share/data-prepper/config/data-prepper-config.yaml',
          'ENV_PIPELINE_FILEPATH': '/usr/share/data-prepper/pipelines/pipelines.yaml'
        ]
        extraDirectories {
            paths {
                path {
                    from = file("${project.projectDir}/config/default-data-prepper-config.yaml") 
                    into = '/usr/share/data-prepper/config/data-prepper-config.yaml'
                }
                path {
                    from = file("${project.projectDir}/config/default-keystore.p12") 
                    into = '/usr/share/data-prepper/keystore.p12'
                }
            }
        }
        // jvmFlags = ['-Xms512m', '-Xmx1024m']
        // ports = ['8080']
    }
}

jib.dependsOn(':data-prepper-main:build')
